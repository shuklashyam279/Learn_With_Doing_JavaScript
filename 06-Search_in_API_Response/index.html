<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search in API Response</title>
    <link rel="stylesheet" href="../styles.css" />
  </head>
  <body>
    <nav>
      <a href="/" aria-current="page">Home</a>
    </nav>
    <script src="update.js"></script>
    <script>
      var listdata;

      const form = document.createElement("form");
      document.body.appendChild(form);
      const searchInput = document.createElement("input");
      searchInput.type = "text";
      searchInput.id = "search_input";
      searchInput.placeholder = "Search by Name, Email, or Username";
      searchInput.style.width = "300px";
      searchInput.style.height = "50px";
      searchInput.style.fontSize = "16px";
      searchInput.style.padding = "10px";
      searchInput.style.marginBottom = "20px";
      searchInput.style.border = "2px solid #007bff";
      searchInput.style.borderRadius = "4px";
      searchInput.style.display = "block";
      searchInput.style.margin = "0 auto";
      form.appendChild(searchInput);

      // Prevent the form from submitting
      form.addEventListener("submit", function (e) {
        e.preventDefault();
      });
      const searchVal = document.getElementById("search_input").value;
      // console.log(searchVal);
      // console.log(typeof searchVal);

      searchInput.addEventListener("input", (e) => {
        let arr = [];
        document.getElementById("response-list").innerHTML = "";
        listdata.forEach((i) => {
          // console.log(e.target.value);
          //lowercase search
          if (
            i.name.toLowerCase().includes(e.target.value.toLowerCase()) ||
            i.email.toLowerCase().includes(e.target.value.toLowerCase()) ||
            i.username.toLowerCase().includes(e.target.value.toLowerCase())
          ) {
            arr.push(i);
            // console.log(i);
          }
        });
        showResponse(arr);
      });

      // ---------------------------------------------------------------------------------
      // const deleteBtn = document.createElement("button");
      // deleteBtn.id = "delete_btn";
      // deleteBtn.type = "button";
      // deleteBtn.textContent = "Delete";
      // deleteBtn.style.marginRight = "10px";
      // form.appendChild(deleteBtn);


      // ---------------------------------------------------------------------------------
      const responseDiv = document.createElement("div");
      responseDiv.id = "response";
      const list = document.createElement("ol");
      list.id = "response-list";
      responseDiv.appendChild(list);
      document.body.appendChild(responseDiv);

      const showResponse = function (responseData) {
          list.innerHTML = "";

        // if no data, nothing to show
        if (!responseData || responseData.length === 0) return;

        responseData.forEach((item) => {
          const listItem = document.createElement("li");
          listItem.id = `item-${item.id}`;
          listItem.style.marginBottom = "10px";

          // main text
          const text = document.createElement("span");
          text.textContent = `Title: ${item.name}, Email: ${item.email}, Username: ${item.username}, Contact: ${item.phone}`;
          listItem.appendChild(text);

          // delete button for each item
          const itemDeleteBtn = document.createElement("button");
          itemDeleteBtn.type = "button";
          itemDeleteBtn.textContent = "Delete";
          itemDeleteBtn.style.marginLeft = "10px";

          // delete functionality
          itemDeleteBtn.addEventListener("click", function () {
            if (Array.isArray(listdata)) {
              listdata = listdata.filter((user) => user.id !== item.id);
              saveToSessionStorage();
              showResponse(listdata);
            }
          });

          // update button for each item
          const itemUpdateBtn = document.createElement("button");
          itemUpdateBtn.type = "button";
          itemUpdateBtn.textContent = "Update";
          itemUpdateBtn.style.marginLeft = "10px";
          
          // update functionality
          itemUpdateBtn.addEventListener("click", function () {
            // Open the modal form from update.js
            openUpdateForm(item, function (updatedData) {
              // Find the user in listdata and update it
              const userIndex = listdata.findIndex((user) => user.id === updatedData.id);
              if (userIndex !== -1) {
                listdata[userIndex] = updatedData;
                saveToSessionStorage();
                showResponse(listdata);
              }
            });
          });

          listItem.appendChild(itemDeleteBtn);
          listItem.appendChild(itemUpdateBtn);
          list.appendChild(listItem);
        });
      };

      //---------------------------------------------------------------------------------

      function saveToSessionStorage() {
        sessionStorage.setItem("userData", JSON.stringify(listdata));
        // console.log("âœ“ Data saved to session storage");
      }
      // ---------------------------------------------------------------------------------

      fetch("https://jsonplaceholder.typicode.com/users")
        .then((response) => response.json())
        .then((json) => {
          listdata = json;
          showResponse(listdata);
          saveToSessionStorage();
        })
        .catch((error) => console.error("Error fetching data:", error));

      //---------------------------------------------------------------------------------
    </script>
  </body>
</html>
